# v2.14 변경사항 - DB 중심 아키텍처

## 📋 주요 변경사항

### 1. ✅ 파일 정리
**루트 디렉토리에 핵심 파일만 유지:**
- `main.py` - 메인 실행 파일
- `config.py` - 설정
- `product_extractor.py` - 상품 추출

**이동된 파일:**
- `test_*.py` → `scripts/archive/` (9개)
- `check_db_status.py` → `scripts/`
- `analyze_unified_log.py` → `scripts/`
- `init_db.py` → `scripts/`
- `collect_fresh_cookies.py` → `scripts/`

### 2. 🗄️ DB 스키마 변경

**tls_fingerprints 테이블 수정:**
```sql
-- 제거된 제약조건/컬럼
- UNIQUE KEY unique_device (누적 저장 위해)
- test_mode 컬럼
- is_valid 컬럼

-- 변경된 동작
- UPSERT → INSERT (매번 새로 저장)
- 동일 디바이스도 여러 번 저장 가능 (패턴 분석용)
```

**device_selections 테이블 추가:**
```sql
CREATE TABLE device_selections (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    device_name VARCHAR(100),
    browser VARCHAR(50),
    os_version VARCHAR(20),
    category VARCHAR(50),
    selected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    KEY idx_device (device_name, browser, os_version),
    KEY idx_selected (selected_at)
);
```

### 3. 🔄 TLS 수집 로직 변경

**이전 (v2.13):**
- 파일 시스템에서 유효성 체크
- 유효하면 재사용 (영구 보관)
- 1개 디바이스 = 1개 TLS 레코드

**현재 (v2.14):**
- 매번 새롭게 수집
- DB에 누적 저장 (INSERT만)
- 1개 디바이스 = N개 TLS 레코드 (패턴 분석용)

**변경 파일:**
- `collectors/dynamic_collector.py`
  - `_is_data_valid()`: 항상 False 반환
  - 매 실행마다 BrowserStack 세션 생성
  - DB에 누적 저장

- `lib/db/db_manager.py`
  - `save_tls_fingerprint()`: UPSERT → INSERT
  - `test_mode` 파라미터 제거

### 4. 📱 디바이스 선택 기록 DB 전환

**이전 (v2.13):**
```python
# 파일 시스템
last_selection.json 파일 읽기/쓰기
{
  "version": 3,
  "last_category": "galaxy",
  "last_device_by_category": {...},
  "devices": {...}
}
```

**현재 (v2.14):**
```python
# DB
db.get_last_device_selection()  # 조회
db.save_device_selection(...)   # 저장

# 레코드
{
  "device_name": "Samsung Galaxy A10",
  "browser": "samsung",
  "os_version": "9.0",
  "category": "galaxy",
  "selected_at": "2025-10-25 10:20:00"
}
```

**변경 파일:**
- `lib/device/device_selector.py`
  - 파일 로드 → DB 조회
  - 파일 저장 → DB 저장
  - `last_selection.json` 의존성 제거

### 5. 💾 데이터 흐름 변경

**이전:**
```
main.py
  → DynamicCollector
    → 파일 검증 (_is_data_valid)
    → 유효하면 파일 재사용
    → TLS 수집 (조건부)
    → 파일 저장
    → DB 저장 (선택)
```

**현재:**
```
main.py
  → DynamicCollector
    → 매번 TLS 수집 (무조건)
    → DB 저장 (필수)
    → 파일 저장 (백업)
  → device_selector
    → DB에서 이전 선택 로드
    → DB에 새 선택 저장
```

## 📊 마이그레이션

**실행:**
```bash
source venv/bin/activate
python scripts/migrate_db_schema.py
```

**수행 작업:**
1. tls_fingerprints 테이블 수정
   - UNIQUE KEY 제거
   - test_mode, is_valid 컬럼 제거
2. device_selections 테이블 생성
3. last_selection.json → device_selections 마이그레이션

## 🎯 효과

### 1. 패턴 분석 가능
- 수백 개 TLS 데이터 누적
- GREASE 변동 패턴 분석
- Extension 순서 패턴 분석
- 디바이스별 TLS 변동성 연구

### 2. 파일 관리 단순화
- 루트에 핵심 파일 3개만
- 테스트 파일 정리
- DB 중심 아키텍처

### 3. 확장성
- 여러 디바이스 동시 테스트 가능
- 시간대별 TLS 패턴 분석
- 크롤링 성공률 통계

## 🔍 주요 변경 파일

| 파일 | 변경 사항 |
|------|----------|
| `lib/db/db_manager.py` | save_tls_fingerprint() UPSERT → INSERT<br>save_device_selection() 추가<br>get_last_device_selection() 추가 |
| `collectors/dynamic_collector.py` | _is_data_valid() 항상 False<br>매번 TLS 수집<br>test_mode 제거 |
| `lib/device/device_selector.py` | 파일 → DB 전환<br>last_selection.json 제거 |
| `scripts/migrate_db_schema.py` | DB 스키마 마이그레이션 |

## 📝 사용 방법

**변경 없음:**
```bash
source venv/bin/activate
python main.py --keyword "검색어"
```

**동작:**
1. 디바이스 선택 (DB에서 이전 선택 로드)
2. TLS 새로 수집 (매번)
3. DB에 누적 저장
4. 크롤링 실행
5. 결과 DB 저장

**데이터 확인:**
```bash
# TLS 누적 데이터 확인
python scripts/check_db_status.py

# 특정 디바이스 TLS 패턴 분석
SELECT
    device_name,
    browser,
    COUNT(*) as count,
    COUNT(DISTINCT ja3_hash) as unique_ja3
FROM tls_fingerprints
GROUP BY device_name, browser;
```

---

**마지막 업데이트:** 2025-10-25
**버전:** v2.14
